<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <section id="guide">
      <p>Press <kbd>Enter</kbd> to submit message</p>
      <p>Press <kbd>/</kbd> to select <kbd>Esc</kbd> to deselect</p>
    </section>
    <section>
      <div id="messages">
        <p style='text-align:center;color: #ffa500;'>This is the start of all messages</p>
        <!-- 
        <div>
          <a href='#'><img class='profile-image' src='/img/0000001.jpg'></a>
          <div class="message-container">
            <p class='message-info'>g4o2 2022/12/18</p>
            <p class='message'><span>A message</span><button class='edit-message'>Edit</button></p>
          </div>
        </div> -->
      </div>
      <form id='form' action="" autocomplete="off">
        <div>
          <!--<input pattern=".{1,}" required title="3 characters minimum" id='message-input' type="text" name="message" size="60" placeholder="Enter message and submit" />-->
          <input id='input' autocomplete="off" type="text" name="message" size="60" style="width: 55vw;"
            placeholder="Enter message and submit" /><button class='btn button' id="send">Send</button>
        </div>
      </form>


    <script src="/socket.io/socket.io.js"></script>
    <script>     
    var socket = io();

    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    const usernameRegex = /\w/g;
    do {
        username = prompt('Username');
    } while (!username.match(usernameRegex))
    if(username) {
        socket.emit('user-connect', username);
    }

    function getUserTimezone() {
      return Intl.DateTimeFormat().resolvedOptions().timeZone;
    }
    function getUserDateTime() {
      return new Date().toLocaleString('en-US', { timeZone: getUserTimezone() });
    }


    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
          var date = getUserDateTime();
          messageDetails = {
            username: username,
            message: input.value,
            date: date
          }
            socket.emit('message-submit', messageDetails);
            input.value = '';
        }
    });

    socket.on('message-submit', function(messageDetails) {
      var pfpLink = '#';
      var item = document.createElement('div');
      item.innerHTML = `<a href='${pfpLink}' ><img class='profile-image' src='/img/0000001.jpg'></a><div class='message-container'><p class='message-info'>${messageDetails.username} ${messageDetails.date}</p><p class='message'><span>${messageDetails.message}</span><button class='edit-message'>Edit</button></p></div>`;
      messages.appendChild(item);
      let chat = document.getElementById('messages')
      chat.scrollTop = chat.scrollHeight;
    });
    socket.on('user-connect', function(username) {
        var item = document.createElement('div');
        item.textContent = `User ${username} connected`;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    })



    window.addEventListener("keydown", event => {
        if ((event.keyCode == 191)) {
          if (input === document.activeElement) {
            return;
          } else {
            input.focus();
            input.select();
            event.preventDefault();
          }
        }
        if ((event.keyCode == 27)) {
          if (input === document.activeElement) {
            document.activeElement.blur();
            window.focus();
            event.preventDefault();
          }
        }
      });
    </script>
  </body>
</html>